# PyKMIP Usage Demo

## Introduction
This provides instructions on how to setup an End to End Demo of Accumulo, PyKMIP, and pelz. There are pelz, Accumulo, Accumulo Plugin, and PyKMIP server installation steps as well as the setup steps for the proxy server and the certificate/key pairs.

The demostration install/setup Accumulo, pelz, PyKMIP, and the proxy server then shows the flow of requests for the successful encryption of Accumulo's File Encryption Key (FEK) by the PyKMIP Key Encryption Key (KEK). The flow starts with Accumulo generating a FEK for its internal file encryption then sent to pelz to be encrypted by the KEK. The Accumulo request is sent JSON formatted to pelz with the KEK and the Key Unique Identification (UID). The Key UID has the location and identification (ID) of the KEK. Pelz requests the KEK from the PyKMIP server through the proxy server. PyKMIP verifies the request and sends the KEK back to the pelz enclave through the proxy server. The KEK is encrypted in transit and only in clear text at the server and pelz's enclave. Pelz uses the KEK for encryption and decryption for Accumulo's FEKs per the requests.

The demostration has four cert/key pairs and two keys for encryption. The two encryption keys are the File Encryption Key (FEK) and the Key Encryption Key (KEK). The KEK is keep on the PyKMIP server and will be securely transfered to the pelz enclave for FEK encyption.  The FEK will be generated by Accumulo for its internal file encryption then sent to pelz to be encrypted by the KEK for save storage of the FEK.  The four cert/key pairs are the one for the node, two for the proxy server, and one for PyKMIP server. The two proxy server cert/key pairs are for each individual connection to the node and PyKMIP.

The instructions assumes that SGX and TPM are already working on the demo system.

## Steps for End to End demo of PyKMIP, Accumulo, and pelz. 

### Pelz Installation Steps
1.  Open terminal
2.	Clone pelz repo and run install script

		git clone https://github.com/NationalSecurityAgency/pelz.git
		cd pelz
		./install.sh

### Accumulo and Accumulo Plugin Installation Steps 
3. Download the Accumulo source and setup pelz plugin

		cd ..
		git clone https://github.com/apache/accumulo.git
		sudo apt install maven openjdk-11-jdk libxml2-utils
		cd pelz/accumulo_plugin
		./setup_plugin.sh -i -d ~/accumulo/ -p
		cd ..

### PyKMIP Server Installaiton/Setep Steps
4.  Run PyKMIP Script in a separate terminal

		./pykmip_demo/PyKMIP_setup.sh

5.  Run the server in a separate terminal

		pykmip-server

6.  Register keys with the server

		./pykmip_demo/register_keys_pykmip.sh


### Certificate and PKey Creation/Installation Steps
7.	Generate Certificates and PKeys for server and client then seal

		cd test/data
		./gen_test_keys_certs.bash
		openssl x509 -in proxy_pub.pem -inform pem -out proxy_pub.der -outform der
		openssl pkey -in node_priv.pem -inform pem -out node_priv.der -outform der
		cd ../..
		./bin/pelz seal test/data/proxy_pub.der -o test/data/proxy_pub.der.nkl
		./bin/pelz seal test/data/node_priv.der -o test/data/node_priv.der.nkl

8.	Run the pelz-service in a separate terminal

		cd pelz
		./bin/pelz-service -m 200

9.	Load server certificate and client PKey

		./bin/pelz pki load cert test/data/proxy_pub.der.nkl
		./bin/pelz pki load private test/data/node_priv.der.nkl

### Proxy Server Setep Steps
10.	Build the proxy server in a separate terminal

		cd pelz/kmyth/sgx
		make clean demo-all
		cd ../..
		./kmyth/sgx/demo/bin/tls-proxy -r test/data/proxy_priv.pem -u test/data/node_pub.pem -p 7000 -I localhost -P 5696 -C /etc/pykmip/certs/root_certificate.pem -R /etc/pykmip/certs/proxy_priv.pem -U /etc/pykmip/certs/proxy_pub.pem

### End to End Demo Step
11. Run Accumulo Test

		cd ../accumulo
		mvn clean
		kdestroy -A
		mvn test

